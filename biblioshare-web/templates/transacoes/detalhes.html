{% extends "base.html" %}
{% load static %}
{% block title %}Transação · BiblioShare{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <p class="text-muted mb-1">Transação #{{ transacao.id }}</p>
    <h1 class="h3 mb-0">{{ transacao.get_tipo_display }}</h1>
  </div>
  <span class="badge fs-6 text-bg-light border">{{ transacao.get_status_display }}</span>
</div>

<div class="row g-4 mb-4">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body">
        <h2 class="h5">Livro principal</h2>
        <p class="mb-1 fw-semibold">{{ transacao.livro_principal.titulo }}</p>
        <p class="text-muted mb-2">{{ transacao.livro_principal.autor }}</p>
        <p class="mb-0"><strong>Dono:</strong> {{ transacao.dono.get_full_name|default:transacao.dono.username }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body">
        <h2 class="h5">Participantes</h2>
        <p class="mb-1"><strong>Solicitante:</strong> {{ transacao.solicitante.get_full_name|default:transacao.solicitante.username }}</p>
        <p class="mb-0"><strong>Dono:</strong> {{ transacao.dono.get_full_name|default:transacao.dono.username }}</p>
        {% if transacao.data_limite_devolucao %}
          <hr>
          <p class="mb-0"><strong>Devolução até:</strong> {{ transacao.data_limite_devolucao|date:"d/m/Y" }}</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if transacao.tipo == 'TROCA' %}
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h2 class="h5 mb-3">Livros oferecidos</h2>
          {% if transacao.livros_oferecidos.all %}
            <ul class="list-unstyled mb-0">
              {% for livro in transacao.livros_oferecidos.all %}
                <li class="mb-2">
                  <div class="fw-semibold">{{ livro.titulo }}</div>
                  <small class="text-muted">{{ livro.autor }}</small>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">Nenhum livro oferecido.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h2 class="h5 mb-3">Livros solicitados (extras)</h2>
          {% if transacao.livros_solicitados.all %}
            <ul class="list-unstyled mb-0">
              {% for livro in transacao.livros_solicitados.all %}
                {% if livro.pk != transacao.livro_principal.pk %}
                  <li class="mb-2">
                    <div class="fw-semibold">{{ livro.titulo }}</div>
                    <small class="text-muted">{{ livro.autor }}</small>
                  </li>
                {% endif %}
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted mb-0">Nenhum livro adicional solicitado.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endif %}

{% if pode_aceitar or pode_recusar or pode_cancelar %}
  <div class="card mb-4">
    <div class="card-body d-flex flex-wrap gap-2">
      {% if pode_aceitar %}
        <form method="post" class="me-2">
          {% csrf_token %}
          <input type="hidden" name="acao" value="aceitar">
          <button class="btn btn-success" type="submit">Aceitar solicitação</button>
        </form>
        <form method="post" class="me-2">
          {% csrf_token %}
          <input type="hidden" name="acao" value="recusar">
          <button class="btn btn-outline-danger" type="submit">Recusar</button>
        </form>
      {% endif %}
      {% if pode_cancelar %}
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="acao" value="cancelar">
          <button class="btn btn-outline-secondary" type="submit">Cancelar transação</button>
        </form>
      {% endif %}
    </div>
  </div>
{% endif %}

<div
  class="card mb-4"
  data-chat-transacao="true"
  data-transacao-id="{{ transacao.id }}"
  data-chat-endpoint="{% url 'transacoes_api:transacoes-mensagens' pk=transacao.id %}"
>
  <div class="card-body d-flex flex-column">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h5 mb-0">Chat da transação</h2>
      <small class="text-muted" data-chat-status>Conectando...</small>
    </div>
    <div
      class="border rounded p-3 mb-3 chat-mensagens"
      data-chat-mensagens
      data-usuario-id="{{ request.user.id }}"
      style="max-height: 320px; overflow-y: auto;"
    >
      <p class="text-muted mb-0" data-chat-placeholder>Nenhuma mensagem ainda.</p>
    </div>
    <form class="d-flex flex-column flex-md-row gap-2" data-chat-form>
      {% csrf_token %}
      <div class="flex-grow-1">
        <textarea
          class="form-control"
          rows="2"
          maxlength="1000"
          placeholder="Digite uma mensagem"
          required
          data-chat-input
        ></textarea>
      </div>
      <button class="btn btn-primary flex-shrink-0" type="submit">Enviar</button>
    </form>
    <div class="text-danger small mt-2 d-none" data-chat-error></div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <h2 class="h5 mb-3">Histórico de status</h2>
    {% if historicos %}
      <ul class="list-unstyled mb-0">
        {% for registro in historicos %}
          <li class="mb-3">
            <div class="fw-semibold">{{ registro.get_status_anterior_display }} → {{ registro.get_status_novo_display }}</div>
            <small class="text-muted">
              {{ registro.usuario.get_full_name|default:registro.usuario.username }} ·
              {{ registro.criado_em|date:"d/m/Y H:i" }}
            </small>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted mb-0">Nenhuma alteração registrada ainda.</p>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
  <script src="{% static 'js/chat-transacao.js' %}"></script>
{% endblock %}

